# 程序的机器级表示

## 简介

1. 计算机执行机器代码，使用字节序列编码低级的操作，包括处理数据，管理内存，读写存储设备上的数据，以及利用网络通信。
2. 编辑器基于汇编语言的规则，目标机器的指令集和操作系统遵顼的惯例生成机器指令。
   * GCC编译器以汇编代码的形式输出，汇编代码时机器代码的文本标识，给出程序中的每一条指令。然后GCC调用汇编器和连接器，根据汇编代码生成机器代码。
   * 阅读汇编代码是一种很重要的能力，我们能够理解编译器的优化能力，分析代码中的隐含的低效率。
   * 例如： 使用线程包写并发程序时，了解不同的线程是如何共享程序数据或保持数据私有，以及准确知道如何在哪里访问共享数据。
   * 而且： 程序遭受攻击的许多种方式中。都涉及程序存储运行时控制信息的方式的细节。许多攻击利用了系统程序中的漏洞重写信息，从而获得系统的控制权。

## 程序编码

### 编译简介

1. 假如一个c程序，有两个文件p1.c和p2.c
   * `gcc -Og -o p p1.c p2.c`
     * `-Og`: 告诉编译器使用会生成符合原始C代码整体结构的机器代码的优化等级

### 机器级代码

1. 正如前面所说，计算机系统使用了多种不同形式的抽象，利用更简单的抽象模型莱茵持仓实现的细节。其中两种抽象尤为重要
   1. 指令集体系结构或指令集架构(Instruction Set Architecture, ISA)： 定义机器级程序的格式和行为，定义了处理器状态，指令的格式，以及每条指令对状态的影响。(大多数ISA，将程序的行为描述成好像每条指令都是顺序执行)
   2. 机器级程序使用的内存地址是虚拟地址： 提供的内存模型，看上去就是一个非常大的字节数组
2. x86-64的机器代码和原始C代码差别非常大。一些通常对C程序员隐藏的处理器状态都是可见的。
   1. `程序计数器(PC)`: 在x86-64中使用`%rip`表示，给出将要执行的下一条指令在内存中的地址
   2. `整数寄存器`： 包含16个命名的位置，分别存储64位的值，这些寄存器可以存储地址或整数数据。
      * 有的寄存器被用来记录某些重要的程序状态， 
      * 其他寄存器用来保存临时数据(参数，局部变量)，以及函数的返回值
   3. `条件码寄存器`： 保存着最近执行的算术或逻辑指令的状态信息，他们用来实现控制流或数据流中的条件变化
   4. `一组向量寄存器`： 可以用来存放一个或多个整数或浮点数值
3. 程序内存包含
   1. 程序的可执行机器代码
   2. 操作系统需要的一些信息
   3. 用来管理过程调用和返回的运行时栈
   4. 已经用户分配的内存块(比如使用malloc分配的)
4. 程序内存使用虚拟地址，但是任意时刻只有有限的一部分虚拟地址是合法的，在目前x86-64实现中, 高16位需要置0。操作系统负责管理虚拟地址空间，将虚拟地址翻译为处理器内存中的物理地址
5. 示例操作
   1. 得到汇编代码: `gcc -Og -S mstore.c`
   2. 得到intel格式的汇编代码: `gcc -Og -masm=intel mstore.c`
   3.  反汇编操作`objdump -d mstore.o`
   4. 反汇编生成intel: `objdump -d -M intel mstore.o`